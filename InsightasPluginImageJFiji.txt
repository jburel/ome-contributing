Insight as Plugin ImageJ/Fiji
==============================



**To test in**: ImageJ, Fiji

**Purpose of the test** is to check that the OMERO insight works as plugin for ImageJ/Fiji and the ``bioformats_package.jar`` or ``loci_tools.jar`` missing is not causing a crash.

**Test on Linux as well as Windows (XP and Win7 if possible)**

#. Download the ``OMERO.insight-ij*`` build and unzip it [or copy it into] in ImageJ/plugins folder [:ref:`InsightIJI001`]

**ImageJ and ImageJ2**

Note: You can download ImageJ2 from http://developer.imagej.net/downloads.

#. Add neither ``bioformats_package.jar`` nor ``loci_tools.jar`` to the Plugins folder of ImageJ (or ImageJ2). If it is there, remove it.


#. Start ImageJ (or ImageJ2) and go ``Plugins`` > ``OMERO`` > ``Connect to OMERO``

   - |C| that a popup appears indicating that ``bioformats_package.jar`` or ``loci_tools.jar`` is missing.[:ref:`InsightIJI002`]

#. (For the release-day testing only.) Click on the hyperlink in the popup and check it brings you to a sensible place, but do not download it. 

#. (For the release-day testing only.) Download ``bioformats_package.jar`` [:ref:`InsightIJI005`] from the RC Download page which is being prepared for the release, e.g. ``https://downloads.openmicroscopy.org/bio-formats/<version>`` (find link in the Standup Notes) . 

   - |C| that the ``bioformats_package.jar`` version (==the Bio-Formats version) you are downloading matches the version of the ``OMERO.insight-ij*`` plugin (for example OMERO 5 ``bioformats_package.jar`` with OMERO 5 ``OMERO.insight-ij*`` plugin). To check the ``bioformats_package.jar`` version, open ImageJ (or ImageJ2), go ``Help > About Plugins > Bio-Formats Plugins`` or ``Help > About Plugins > LOCI Plugins``  [:ref:`InsightIJI004`].

#. (For non-release-day testing only.) Download both ``bioformats_package.jar`` and ``loci_tools.jar`` that are mentioned in the popup.

   - |C| that the ``bioformats_package.jar`` version (==the Bio-Formats version) you are downloading matches the version of the ``OMERO.insight-ij*`` plugin (for example OMERO 5 ``bioformats_package.jar`` with OMERO 5 ``OMERO.insight-ij*`` plugin). To check the ``bioformats_package.jar`` version, open ImageJ, go ``Help > About Plugins > Bio-Formats Plugins`` or ``Help > About Plugins > LOCI Plugins`` [:ref:`InsightIJI004`]. **Note** that when testing OMERO 5, the link in the popup will point to a wrong place - you might need to download the corresponding ``bioformats_package.jar`` from OMERO 5 Bio-Formats download page (e.g. ``http://downloads.openmicroscopy.org/bio-formats/5.0.0-xxx/``).

#. Quit ImageJ. Copy ``bioformats_package.jar`` into ``Plugins`` folder of ImageJ [:ref:`InsightIJI001`].

#. Restart ImageJ (or ImageJ2), and go ``Plugins`` > ``OMERO`` > ``Connect to OMERO``

   - |C| that Insight splashscreen is displayed.

#. Log in.

#. Go to the left-hand pane and select an image or import one if no images available.

#. Double-click on the image and then click ``OK`` in the ``Bio-Formats Import Options`` window [:ref:`InsightIJI006`].

   - |C| that the image opens in ImageJ [:ref:`InsightIJI007`].

#. Replace the ``bioformats_package.jar`` with ``loci_tools.jar`` and repeat the steps 4 (on release day only) or 5 (non-release day only) and 6, 7, 8, 9 and 10 (on both release and non-release days). 

#. Put both ``bioformats_package.jar`` and ``loci_tools.jar`` into Plugins folder and restart ImageJ (or ImageJ2). 

   - |C| that a duplication warning appears [:ref:`InsightIJI007b`].
   - |C| that you can still connect to OMERO and open an image.

#. Go through all steps using ImageJ64 and the platform independent version of ImageJ (download from `ImageJ homepage <http://rsbweb.nih.gov/ij/download.html>`_).


**ImageJ - ROI and OMERO upload**
(This section is just pre-release testing scenario, do not do on release day, on release day go to section **Fiji**)

#. (5.1 only) Open an image in ImageJ, draw regions using IJ toolbar and ``Analyze > Tools > ROI Manager``. Each time you draw a new region click ``Add`` in the ``ROI Manager`` (``Ctrl + t`` can be used as keyboard shortcut).

   - export the image using ``Plugins > Bio-formats > Bio-formats Exporter`` to the local drive on your machine
   - make sure the ``Export ROIs`` tickbox in the second dialog (``Bio-Formats Exporter Options``) is ticked BY DEFAULT.
   - close the image
   - close the ``ROI Manager``
   - reimport the saved image using ``Plugins > Bio-formats > Bio-formats Importer``, selecting the checkboxes ``Display ROIs``, ``Display OME-XML metadata`` and ``Display Metadata`` in the ``Bio-formats importer`` options)
   - |C| that the ``ROI Manager`` dialog pops up and lists all the regions you saved previously
   - |C| that when you tick the ``Show all`` tickbox in ``ROI Manager`` you see the regions just as you saved them on the image
   - Import the image you created into OMERO (using OMERO.insight).
   - |C| that the image has regions as you have drawn them in ImageJ and the regions are correctly displayed in Insight and Web.

#. (5.1 only) Repeat step 1., this time draw regions using IJ toolbar and ``Image > Overlay > Add selection`` or use the shortcut ``cmd B``. Note that any regions in ``ROI Manager`` will be ignored in case the image has an ``Overlay`` to it. 

#. Open an image in ImageJ, create a rectangular region, and make a crop (``Image > Crop``). 
   
   - create a region in the cropped image and go ``Plugins > OMERO > Upload and Save to OMERO``
   - |C| that the Data Manager of Insight opens followed immmediately by Importer
   - |C| that the radio button option in the Importer is ``Current image....``
   - |C| that when you click ``Add to Queue`` the 


#. Open an image stored in OMERO in ImageJ using the imageJ plugin
    
   - draw a ROI and add it to the ROI Manager in ImageJ
   - crop the image (draw a rectangle encompassing the region you have just drawn and select ``Image > Crop``)
   - select "Save ROIs to OMERO" item in ``Plugins > OMERO``
   - |C| that the image is imported as ome-tiff WITH the region you have drawn on it.

#. 





**Fiji**

#. Start Fiji

#. Go ``Help`` > ``Update Fiji`` -> the update process will start.

   - |C| whether the Bio-Formats version you have in your Fiji matches the version of the ``OMERO.insight-ij*`` plugin (for example Bio-Formats 5 with OMERO 5``OMERO.insight-ij*`` plugin). To check the Bio-Formats version, go ``Help > About Plugins > LOCI Plugins`` [:ref:`InsightIJI004`]. **Note** that Fiji no longer supports Bio-Formats 4 and thus the ``OMERO.insight-ij*`` must be OMERO 5 to work with Fiji.

#. Add the ``OMERO.insight-ij*`` plugin to the ``Plugins`` folder of Fiji - on Mac, use rigth-click on Fiji icon & ``Show package content`` [:ref:`InsightIJI003`] to get to ``Plugins`` 

#. Restart Fiji

#. Go ``Plugins`` > ``OMERO`` > ``Connect to OMERO``

   - |C| that Insight splashscreen is displayed.

#. Log in.

#. Go to the left-hand pane and select an image or import one if no images available.


#. Double-click on the image and then click ``OK`` in the ``Bio-Formats Import Options`` window [:ref:`InsightIJI006`].

   - |C| that the image opens in Fiji.


**Note**  that during the update, there might be a problem with the class ``org.joda.time.Instant`` which can be found here:

::

    /Applications/Fiji.app/jars/jruby.jar
    /Applications/Fiji.app/jars/loci_tools.jar
    /Applications/Fiji.app/plugins/OMERO.insight-ij-5.0.0-rc1-ice35-b10/libs/joda-time.jar


The warning looks as follows:

::

    WARNING: multiple locations found! java.lang.NoSuchMethodError: org.joda.time.Instant.parse(Ljava/lang/String;Lorg/joda/time/format/DateTimeFormatter;)Lorg/joda/time/Instant;

**Solution**: Delete the ``jruby.jar``.







.. _InsightIJI001:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/001.png
   :align: center

   InsightIJI001 


|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|


.. _InsightIJI002:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/002.png
   :align: center

   InsightIJI002


|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|


.. _InsightIJI003:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/003.png
   :align: center

   InsightIJI003


|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|


.. _InsightIJI004:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/004.png
   :align: center

   InsightIJI004


|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|


.. _InsightIJI005:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/005.png
   :align: center

   InsightIJI005


|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|


.. _InsightIJI006:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/006.png
   :align: center

   InsightIJI006


|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|


.. _InsightIJI007:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/007.png
   :align: center

   InsightIJI007


|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|


.. _InsightIJI007b:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/007b.png
   :align: center

   InsightIJI007b


|
|
|
|
|
|
|
|
|
|
|
|
|
|
|
|

|
|
|
|
|
|
|
|
|
|
|
|


.. _InsightIJI008:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/008.png
   :align: center

   InsightIJI008


|
|
|
|
|
|
|
|
|

|
|
|
|
|
|
|
|


.. _InsightIJI008b:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/008b.png
   :align: center

   InsightIJI008b


|
|
|
|
|
|
|

|
|
|
|
|
|
|
|
|
|


.. _InsightIJI009:
.. figure:: /images/testing_scenarios/InsightasPluginImageJFiji/009.png
   :align: center

   InsightIJI009


|
|
|
|
|
|
|
|
|



