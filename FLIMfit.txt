FLIMfit
========



**To test in**: Insight

Purpose of the test is to check the functionality of the standalone FLIMfit application and the communication with OMERO.insight.

#. On a mac make sure you have the Matlab Compiler Runtime installed - check the version number necessary. The MCR will install automatically on Windows.

#. Download the latest build of FLIMfit from :jenkinsjob:`FLIMFit-latest-mac` or :jenkinsjob:`FLIMFit-latest-win`.
   Select the component matching the version of the OMERO server you want to
   test FLIMFit against.

#. Start FLIMfit by clicking onto the application. Note that the errors are being recorded in the first window which pops up after you start the application.

#. Login to the appropriate OMERO.server in the login dialog.

#. Open Insight and login to the same server as in previous point.

#. Create a new dataset named ``Single`` and import 2 files into it: ``data_repo/test_images_good/sdt/IRF_in_file/convalaria ex 740nm 2 min.sdt`` and ``data_repo/test_images_good/sdt/IRF_in_file/nanorods ex 740 nm 2 min.sdt``.

#. Still in Insight, create a new dataset named ``Multiple`` and import files ``data_repo/test_images_good/sdt/Instrument Response Function/*.sdt`` into it.

#. Still in Insight, go to the dataset ``Multiple`` you just created and attach the file ``data_repo/test_images_good/sdt/Instrument Response Function/IRF 2013-05-22-T-15-36-21.irf`` to this dataset. 

#. Still in Insight, create a new dataset named ``Plate`` and import all ome.tiff files from ``team/pwalczysko/plate_from_Imperial_Ian`` into it.

#. Still in Insight, go to the dataset ``Plate`` you just created and attach the file ``central irf.xml`` to this dataset. 

#. In FLIMfit, go ``OMERO > Load Data``. Choose the ``Single`` dataset that you created in Insight and select the file ``convalaria ex 740nm 2 min.sdt``.

   - |C| that the data have been loaded as expected - you should see the preview of the integrated intensity [screenshot].
   - |C| that when you click into the integrated intensity preview, you get fluorescence decay graphs in the middle pane of FLIMfit.


#. Load the Instrument Response Function (IRF) for this data from an image file

   - Go ``OMERO > Load IRF (Single FOV)`` and select the file ``nanorods ex 740 nm 2 min.sdt``.
   - |C| that you can now see additionally a pulse of the IRF in the fluorescence decay graphs in the main pane [screenshot]

#. Adjust the Integrated Min. parameter

   - Find the ``Integrated Min`` parameter box, enter a value (e.g. 50) and press Enter.
   - |C| that the Integrated Intensity preview gets red areas (threshold) which expand as you increase the number in the "Integrated Min" box.


#. Fit pixel-wise

   - Make sure that the ``Global Fitting`` parameter is set to Pixel-Wise.
   - Make sure that the ``Fit Contributions`` parameter is set to ``Fitted Locally``.
   - Click ``Fit Dataset`` (bottom-left of the application).
   - |C| that the "operation in progress" popup appears.   -

#. Go to Images tab in the central pane of FLIMfit.

   - In the right-hand pane, tick the Display and Merge boxes in the tau-1, IO, I and ch2 rows.
   - |C| that for each of the box ticked, an image appears in the central pane.


#. Go ``OMERO > Export Fitting Results``.

   - |C| that a popup appears indicating that a new dataset was created in OMERO with the exported results.
   - |C| in OMERO.insight that the dataset was indeed created with a 4-channel image (channels: tau_1, IO, I, ch2) in it.
   - |C| that there are 3 attachments on the created dataset -> ``Fit Results Table``, ``data settings`` and ``fitting settings``.
   - |C| that you can open the image and download and view the 3 attachments.

#. Immediately after this, fit pixel-wise again, choosing ``2`` in the ``No. Exp`` menu.

   - |C| that the application finishes the fit without crashing.

#. Load the data (multiple FOVs)

   - Go ``OMERO > Load FLIM Data From a Dataset``. Select the ``Multiple`` dataset you have created in Insight.
   - If on a 5.x.x server then type ``#2`` (or other characters which you can find in the filenames in case ``#2`` is not a part of a filename you work with) into ‘Filter by name’ window & click deselect. This will load only the data from block 1 (or other subset of data according to your selection filter).
   - In the popup check the required files are ticked then click ``Load Selected``.
   - In the popup select channel 0.
   - |C| that the data have been loaded as expected - you should see the preview of the integrated intensity [screenshot] and the list of uploaded files in the top-left corner of the application [screenshot].

#. Load the IRF for the multiple FOVs from an attachment

   - Go ``OMERO > Load IRF (Annotation)``
   - |C| that the pulse of the IRF is visible in the graphs in the central panel under ``Decay`` tab.

#. Adjust the Integrated Min. parameter

   - Find the ``Integrated Min`` parameter box, enter a value of 90 and press Enter.
   - |C| that the Integrated Intensity preview gets red areas (threshold) which exclude pixels outside the cells.


#. Fit Multiple FOVs Globally with 2 exponentials

   - Select ``2`` in the ``No. Exp`` menu.
   - Select ``Global`` in the ``Global Fitting`` menu.
   - Click ``Fit Dataset``.
   - After fitting is finished, go to ``Gallery`` tab in the main pane and in the ``Image`` dropdown on the bottom of the middle pane select ``tau-1``, ``tau-2``, ``beta-1``, ``beta-2``
   - |C| that images in the main pane appear each time when you change the parameter selection
   - Go to ``Plotter`` tab in the main pane and in the ``Parameter`` dropdown select ``mean-tau``.
   - Ensure that you a plot across all the images with error bars



#. Load the data (Plate)

   - Go ``OMERO > Load FLIM Data From a Dataset``. Select the ``Plate`` dataset you have created in Insight.
   - In the popup check the required files are ticked then click ``Load Selected``.
   - |C| that the data have been loaded as expected - you should see the preview of the integrated intensity [screenshot] and the list of uploaded files in the top-left corner of the application [screenshot].

#. Load the IRF for Plate from an attachment

   - Go ``OMERO > Load IRF (Annotation)``
   - Select ``central irf.xml``
   - |C| that the pulse of the IRF is visible in the graphs in the central panel under ``Decay`` tab.

#. Adjust the Integrated Min. parameter

   - Find the ``Integrated Min`` parameter box, enter a value of 1000 and press Enter.
   - |C| that the Integrated Intensity preview gets red areas (threshold) which exclude pixels outside the central circle and the dimmest inside that circle.


#. Fit Plate Globally with 2 exponentials

   - Select ``2`` in the ``No. Exp`` menu.
   - Select ``Global`` in the ``Global Fitting`` menu.
   - Click ``Fit Dataset``.
   - After fitting is finished, go to ``Plate`` tab in the main pane and in the ``Parameter`` dropdown on the bottom of the middle pane select ``mean-tau``.
   - |C| that you can see a variation in colour across the displayed plate (N.B. Row A is unpopulated).
   - Change the ``Mode`` parameter to ``First Image``
   - |C| that you can see the central circle in each well. (Note rows 11 and 12 are dim)














.. seealso::

   `FLIMfit documentation <http://www.openmicroscopy.org/site/support/partner/flimfit>`_.


