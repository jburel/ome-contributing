Registering the usage
=====================


**To test in**: Web, Insight, IJ plugin, Importer, MatLab, Bio-Formats

**Purpose of the test** is to check if ``UpgradeCheck`` hit is registered, this means the usage monitoring of our products is working as expected.

#. For client upgrade tests, write down your IP address 

   .. note::
     Do not use any website to check you IP address as this may give you
     incorrect result.

   - on UNIX, use: ``$ /sbin/ifconfig``
   - on Mac OS X, alternatively go to
     :menuselection:`Apple -> System Preferences -> Network` and find the
     active connection
   - on Windows, open the ``CMD (Command Prompt)`` and type::

       C:\> ipconfig

#. For OMERO.server and OMERO.web tests, use the IP address of the node where 
   the server or the Web is deployed.

#. To check the hits, first connect to feedback database

   - if you are testing the production registry, use the replica of the
     feedback database which is in read-only model::

       psql -h pg-slave.openmicroscopy.org -U feedback feedback

   - if you are testing the staging registry database::
 
       psql -h ome-web-staging.openmicroscopy.org -U feedback feedback

#. |C| if the hit was registered in the database using the following query:

   **Repeat the following steps for each client**, replacing `YOUR_IP` with the correct value::

     SELECT registry_ip.ip, registry_hit.creation_date, registry_agent.agent_name, registry_agent.id
     FROM registry_hit 
     LEFT OUTER JOIN registry_ip ON ( registry_hit.ip_id = registry_ip.id )
     LEFT OUTER JOIN registry_agent ON ( registry_hit.agent_id = registry_agent.id )
     WHERE registry_ip.ip = 'YOUR_IP'
     ORDER BY registry_hit.id DESC LIMIT 5;

   You should see results like::

           ip       |         creation_date         |   agent_name   | id 
     ---------------+-------------------------------+----------------+----
      134.36.162.28 | 2015-09-24 09:45:14.112992+01 | OMERO.ij       | 10
      134.36.162.28 | 2015-09-23 11:05:35.554009+01 | OMERO.importer |  1
      134.36.162.28 | 2015-09-23 11:03:10.234792+01 | OMERO.insight  |  2
      134.36.162.28 | 2015-09-23 09:52:05.933021+01 | OMERO.web      |  5

#. Download the appropriate clients:

   - to test the production registry application, go to
     http://downloads.openmicroscopy.org/omero/, choose appropriate version
     and download the packages.

   - to test the staging registry application, download the merge clients from
     :jenkinsjob:`OMERO-DEV-merge-build` or
     :jenkinsjob:`BIOFORMATS-DEV-merge-build`.
     The CI :jenkinsjob:`OMERO-DEV-merge-deploy` server should also be
     configured to point the staging registry.

#. Test the various clients:

   .. list-table::
     :widths: 10,90

     *
       - Agent
       - Testing scenario

     *
       - OMERO.importer
       - Open the OMERO.importer client and log in to the given server

     *
       - OMERO.insight
       - Open the OMERO.insight client and log in to the given server

     *
       - OMERO.editor
       - Open the OMERO.editor client and log in to the given server

     *
       - OMERO.fs
       -

     *
       - OMERO.web
       - Open the OMERO.web client and log in to the given server

     *
       - OMERO.server
       - Start the OMERO.server ``bin/omero admin start``

     *
       - OMERO.ij
       -

     *
       - OMERO.diagnostics
       - Run ``bin/omero admin diagnostics``

     *
       - OMERO.shell
       - Run ``bin/omero shell``

     *
       - OMERO.importer-cli
       -

     *
       - OMERO.imagej
       -

         - Copy the appropriate :file:`insight-ij` plugin and the appropriate
           :file:`bioformats_package.jar` into the Plugins folder of your
           ImageJ
         - Open ImageJ
         - Connect to OMERO and log in
         - Make sure there was **only ONE** hit recorded (see the steps 1. -
           2. above for how to do it)
         - Close the :file:`insight-ij` plugin interface running under the
           ImageJ, but do not close ImageJ itself
         - Connect to OMERO (you will be connected automatically)
         - Close the :file:`insight-ij` plugin and ImageJ
         - Make sure there was **only ONE** hit recorded (see the steps 1. -
           2. above for how to do it)

     *
       - OMERO.dropbox
       -

     *
       - OMERO.bioformats
       - Downloads the Bio-Formats command-line tools and run
         ``showinf -nopix test.fake``

     *
       - OMERO.test
       - Run ``bin/omero admin checkupgrade`` (5.2.0 and above)

     *
       - OMERO.matlab
       - N/A

